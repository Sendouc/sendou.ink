import { suite } from "uvu";
import * as assert from "uvu/assert";
import { addLoserTeamSourceInfo } from "./bracket";

const LoserTeamSourceInfo = suite("addLoserTeamSourceInfo()");

const mockBracket = `{"winners":[{"id":"78cd79cf-fe04-4e6d-8f1a-dc14bab4af9c","name":"Winners' Round 1","stages":[{"position":1,"stage":{"id":3987,"name":"Arowana Mall","mode":"SZ"}},{"position":2,"stage":{"id":3975,"name":"MakoMart","mode":"CB"}},{"position":3,"stage":{"id":3928,"name":"Humpback Pump Track","mode":"TC"}}],"matches":[{"number":0,"id":"30654e5d-a220-4264-bcaf-0d162b1ebd30","winnerDestinationMatchId":"149d49e2-da1a-469c-94b2-b070efe59def","loserDestinationMatchId":"d4a96a16-b485-4c34-a751-6c5c6bae664c","participants":["Kraken Paradise",null]},{"number":1,"id":"8cdd804e-8010-431b-81de-81f278444aef","winnerDestinationMatchId":"149d49e2-da1a-469c-94b2-b070efe59def","loserDestinationMatchId":"d4a96a16-b485-4c34-a751-6c5c6bae664c","score":[1,2],"participants":["Kougeki","Last Minute"]},{"number":2,"id":"731c3db0-f903-4b91-946f-23d6f66e6af9","winnerDestinationMatchId":"a8b3e7b4-23f4-43db-ae5a-17b42bc6d64c","loserDestinationMatchId":"8ed564bc-8a0e-450d-8f1c-1d3f544a183f","score":[0,0],"participants":["Starburst","Arctic Moon"]},{"number":3,"id":"07aa5c6b-3b8a-417a-b526-1b4768cc34dd","winnerDestinationMatchId":"a8b3e7b4-23f4-43db-ae5a-17b42bc6d64c","loserDestinationMatchId":"8ed564bc-8a0e-450d-8f1c-1d3f544a183f","score":[0,0],"participants":["ðŸ›ï¸","sink gang"]},{"number":4,"id":"bef1721f-3dee-47ac-8fdd-f42025b10b2b","winnerDestinationMatchId":"87ee2463-d746-4e71-8b84-1bf9f83e0456","loserDestinationMatchId":"fa446012-413e-4511-84b4-ca20a185728f","score":[0,0],"participants":["Team Blue","NIS"]},{"number":5,"id":"04a440a4-ac0c-4912-bcbd-4a0907d20a6d","winnerDestinationMatchId":"87ee2463-d746-4e71-8b84-1bf9f83e0456","loserDestinationMatchId":"fa446012-413e-4511-84b4-ca20a185728f","score":[0,0],"participants":["Jackpot","Kelp Domers"]},{"number":6,"id":"0b88cf09-9211-416b-9f67-d4f53b5ee69d","winnerDestinationMatchId":"a5d04ed9-2094-448a-a93c-555c71e1e966","loserDestinationMatchId":"800899bc-524a-477a-b822-bec159cbf1c0","score":[0,0],"participants":["CrÃ¨me Fresh","Squidding Good"]},{"number":7,"id":"82a1e13c-9126-450a-97ad-5a9c375b9615","winnerDestinationMatchId":"a5d04ed9-2094-448a-a93c-555c71e1e966","loserDestinationMatchId":"800899bc-524a-477a-b822-bec159cbf1c0","score":[0,0],"participants":["Team Paradise","Woomy Zoomy Boomy"]}]},{"id":"d4d2a025-dd81-4171-8763-31e9c81fe1f1","name":"Winners' Round 2","stages":[{"position":1,"stage":{"id":3934,"name":"Inkblot Art Academy","mode":"RM"}},{"position":2,"stage":{"id":3993,"name":"Goby Arena","mode":"TC"}},{"position":3,"stage":{"id":4002,"name":"Camp Triggerfish","mode":"SZ"}}],"matches":[{"number":8,"id":"149d49e2-da1a-469c-94b2-b070efe59def","winnerDestinationMatchId":"77a922ae-a2b6-46c9-8e63-ec74ff4bf8ce","loserDestinationMatchId":"4cd038cd-c49b-4abe-ac86-2b644ce09a82","score":[0,0],"participants":["Kraken Paradise","Last Minute"]},{"number":9,"id":"a8b3e7b4-23f4-43db-ae5a-17b42bc6d64c","winnerDestinationMatchId":"77a922ae-a2b6-46c9-8e63-ec74ff4bf8ce","loserDestinationMatchId":"31e8c789-161b-407a-9727-f2cd22655d93"},{"number":10,"id":"87ee2463-d746-4e71-8b84-1bf9f83e0456","winnerDestinationMatchId":"0b09af0a-2b18-438f-be2d-cd544388d9d8","loserDestinationMatchId":"906672b3-630b-4737-af25-df8a9ce0724b"},{"number":11,"id":"a5d04ed9-2094-448a-a93c-555c71e1e966","winnerDestinationMatchId":"0b09af0a-2b18-438f-be2d-cd544388d9d8","loserDestinationMatchId":"1e0f6fa4-d3a4-45c6-a15c-205715dc361d"}]},{"id":"50e57dfe-9a89-4853-a5d7-b600c7dcca4f","name":"Winners' Semifinals","stages":[{"position":1,"stage":{"id":3957,"name":"Kelp Dome","mode":"SZ"}},{"position":2,"stage":{"id":3944,"name":"Moray Towers","mode":"RM"}},{"position":3,"stage":{"id":4017,"name":"Ancho-V Games","mode":"SZ"}},{"position":4,"stage":{"id":3920,"name":"Musselforge Fitness","mode":"CB"}},{"position":5,"stage":{"id":3968,"name":"Blackbelly Skatepark","mode":"TC"}}],"matches":[{"number":12,"id":"77a922ae-a2b6-46c9-8e63-ec74ff4bf8ce","winnerDestinationMatchId":"1c8b0364-064a-4eb5-9f4b-e30de56926dc","loserDestinationMatchId":"347de70e-cb77-449b-9a04-baf84a7ac2cf"},{"number":13,"id":"0b09af0a-2b18-438f-be2d-cd544388d9d8","winnerDestinationMatchId":"1c8b0364-064a-4eb5-9f4b-e30de56926dc","loserDestinationMatchId":"743018d7-35c5-4bc2-aecb-d65af4fb4c1e"}]},{"id":"a5ee92ec-8d6b-4997-ada6-5c85e4f70559","name":"Winners' Finals","stages":[{"position":1,"stage":{"id":3954,"name":"Manta Maria","mode":"RM"}},{"position":2,"stage":{"id":3987,"name":"Arowana Mall","mode":"SZ"}},{"position":3,"stage":{"id":4000,"name":"Piranha Pit","mode":"CB"}},{"position":4,"stage":{"id":3992,"name":"Goby Arena","mode":"SZ"}},{"position":5,"stage":{"id":3928,"name":"Humpback Pump Track","mode":"TC"}}],"matches":[{"number":14,"id":"1c8b0364-064a-4eb5-9f4b-e30de56926dc","winnerDestinationMatchId":"facfdc52-7488-49ad-93e5-d7bc253d3de9","loserDestinationMatchId":"4d642c31-8b71-4cd4-b1f6-5552059bad19"}]},{"id":"f5ff0920-9aa0-4ee5-a2c7-f338eb8921ac","name":"Grand Finals","stages":[{"position":1,"stage":{"id":3934,"name":"Inkblot Art Academy","mode":"RM"}},{"position":2,"stage":{"id":4017,"name":"Ancho-V Games","mode":"SZ"}},{"position":3,"stage":{"id":3920,"name":"Musselforge Fitness","mode":"CB"}},{"position":4,"stage":{"id":3967,"name":"Blackbelly Skatepark","mode":"SZ"}},{"position":5,"stage":{"id":4003,"name":"Camp Triggerfish","mode":"TC"}},{"position":6,"stage":{"id":3974,"name":"MakoMart","mode":"RM"}},{"position":7,"stage":{"id":3957,"name":"Kelp Dome","mode":"SZ"}}],"matches":[{"number":28,"id":"facfdc52-7488-49ad-93e5-d7bc253d3de9","winnerDestinationMatchId":"b2fcbb94-a805-4a9e-af87-8a653439cc39","loserDestinationMatchId":"b2fcbb94-a805-4a9e-af87-8a653439cc39"}]},{"id":"00cf4c2e-4f08-491c-8d6b-bca0bd0b8f38","name":"Bracket Reset","stages":[{"position":1,"stage":{"id":3927,"name":"Humpback Pump Track","mode":"SZ"}},{"position":2,"stage":{"id":3945,"name":"Moray Towers","mode":"CB"}},{"position":3,"stage":{"id":3992,"name":"Goby Arena","mode":"SZ"}},{"position":4,"stage":{"id":3954,"name":"Manta Maria","mode":"RM"}},{"position":5,"stage":{"id":3988,"name":"Arowana Mall","mode":"TC"}},{"position":6,"stage":{"id":4002,"name":"Camp Triggerfish","mode":"SZ"}},{"position":7,"stage":{"id":4015,"name":"New Albacore Hotel","mode":"CB"}}],"matches":[{"number":29,"id":"b2fcbb94-a805-4a9e-af87-8a653439cc39","winnerDestinationMatchId":null,"loserDestinationMatchId":null}]}],"losers":[{"id":"2ab8f134-60af-44b8-ac22-84a535512f6c","name":"Losers' Round 1","stages":[{"position":1,"stage":{"id":3957,"name":"Kelp Dome","mode":"SZ"}},{"position":2,"stage":{"id":3968,"name":"Blackbelly Skatepark","mode":"TC"}},{"position":3,"stage":{"id":3955,"name":"Manta Maria","mode":"CB"}}],"matches":[{"number":0,"id":"d4a96a16-b485-4c34-a751-6c5c6bae664c","winnerDestinationMatchId":"4cd038cd-c49b-4abe-ac86-2b644ce09a82","loserDestinationMatchId":null,"participants":[null,"Kougeki"]},{"number":15,"id":"8ed564bc-8a0e-450d-8f1c-1d3f544a183f","winnerDestinationMatchId":"31e8c789-161b-407a-9727-f2cd22655d93","loserDestinationMatchId":null},{"number":16,"id":"fa446012-413e-4511-84b4-ca20a185728f","winnerDestinationMatchId":"906672b3-630b-4737-af25-df8a9ce0724b","loserDestinationMatchId":null},{"number":17,"id":"800899bc-524a-477a-b822-bec159cbf1c0","winnerDestinationMatchId":"1e0f6fa4-d3a4-45c6-a15c-205715dc361d","loserDestinationMatchId":null}]},{"id":"339ee68e-ff89-45b8-97c3-5fd1a8207c12","name":"Losers' Round 2","stages":[{"position":1,"stage":{"id":3934,"name":"Inkblot Art Academy","mode":"RM"}},{"position":2,"stage":{"id":4017,"name":"Ancho-V Games","mode":"SZ"}},{"position":3,"stage":{"id":3928,"name":"Humpback Pump Track","mode":"TC"}}],"matches":[{"number":18,"id":"4cd038cd-c49b-4abe-ac86-2b644ce09a82","winnerDestinationMatchId":"0890c87b-7d1a-4d67-81a9-713b0ae341e0","loserDestinationMatchId":null,"participants":[null,"Kougeki"]},{"number":19,"id":"31e8c789-161b-407a-9727-f2cd22655d93","winnerDestinationMatchId":"0890c87b-7d1a-4d67-81a9-713b0ae341e0","loserDestinationMatchId":null},{"number":20,"id":"906672b3-630b-4737-af25-df8a9ce0724b","winnerDestinationMatchId":"37ef09be-a684-4d35-924f-1660fc2259d5","loserDestinationMatchId":null},{"number":21,"id":"1e0f6fa4-d3a4-45c6-a15c-205715dc361d","winnerDestinationMatchId":"37ef09be-a684-4d35-924f-1660fc2259d5","loserDestinationMatchId":null}]},{"id":"4843b92a-1a4c-4450-8877-8bf3111f4a3f","name":"Losers' Round 3","stages":[{"position":1,"stage":{"id":4002,"name":"Camp Triggerfish","mode":"SZ"}},{"position":2,"stage":{"id":3975,"name":"MakoMart","mode":"CB"}},{"position":3,"stage":{"id":3944,"name":"Moray Towers","mode":"RM"}}],"matches":[{"number":22,"id":"0890c87b-7d1a-4d67-81a9-713b0ae341e0","winnerDestinationMatchId":"347de70e-cb77-449b-9a04-baf84a7ac2cf","loserDestinationMatchId":null},{"number":23,"id":"37ef09be-a684-4d35-924f-1660fc2259d5","winnerDestinationMatchId":"743018d7-35c5-4bc2-aecb-d65af4fb4c1e","loserDestinationMatchId":null}]},{"id":"44aba3bf-f880-4a53-a8b7-e0977a8abd86","name":"Losers' Round 4","stages":[{"position":1,"stage":{"id":3919,"name":"Musselforge Fitness","mode":"RM"}},{"position":2,"stage":{"id":3957,"name":"Kelp Dome","mode":"SZ"}},{"position":3,"stage":{"id":3988,"name":"Arowana Mall","mode":"TC"}}],"matches":[{"number":24,"id":"347de70e-cb77-449b-9a04-baf84a7ac2cf","winnerDestinationMatchId":"f32d2a0f-0e3e-450c-abeb-1194f7e4fded","loserDestinationMatchId":null},{"number":25,"id":"743018d7-35c5-4bc2-aecb-d65af4fb4c1e","winnerDestinationMatchId":"f32d2a0f-0e3e-450c-abeb-1194f7e4fded","loserDestinationMatchId":null}]},{"id":"8559bda2-668f-47f5-a5fa-c85cdbd51ad1","name":"Losers' Round 5","stages":[{"position":1,"stage":{"id":4015,"name":"New Albacore Hotel","mode":"CB"}},{"position":2,"stage":{"id":3954,"name":"Manta Maria","mode":"RM"}},{"position":3,"stage":{"id":4017,"name":"Ancho-V Games","mode":"SZ"}}],"matches":[{"number":26,"id":"f32d2a0f-0e3e-450c-abeb-1194f7e4fded","winnerDestinationMatchId":"4d642c31-8b71-4cd4-b1f6-5552059bad19","loserDestinationMatchId":null}]},{"id":"9cf611b9-bdc8-468c-b29c-fb0e29d94073","name":"Losers' Finals","stages":[{"position":1,"stage":{"id":3967,"name":"Blackbelly Skatepark","mode":"SZ"}},{"position":2,"stage":{"id":4000,"name":"Piranha Pit","mode":"CB"}},{"position":3,"stage":{"id":3992,"name":"Goby Arena","mode":"SZ"}},{"position":4,"stage":{"id":3988,"name":"Arowana Mall","mode":"TC"}},{"position":5,"stage":{"id":3934,"name":"Inkblot Art Academy","mode":"RM"}}],"matches":[{"number":27,"id":"4d642c31-8b71-4cd4-b1f6-5552059bad19","winnerDestinationMatchId":"facfdc52-7488-49ad-93e5-d7bc253d3de9","loserDestinationMatchId":null}]}]}`;

LoserTeamSourceInfo("Adds loser team source info", () => {
  // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
  const withLoserSourceInfo = addLoserTeamSourceInfo(JSON.parse(mockBracket));

  let expectedNumbers = new Array(14).fill(null).map((_, i) => i + 1);

  for (const match of withLoserSourceInfo.flatMap((round) => round.matches)) {
    if (!match.participantSourceMatches) continue;
    if (match.number === 0) continue;

    for (const sourceMatchId of match.participantSourceMatches) {
      if (!sourceMatchId) continue;
      if (!expectedNumbers.includes(sourceMatchId)) {
        throw new Error(`Unexpected match number: ${sourceMatchId}`);
      }

      expectedNumbers = expectedNumbers.filter((num) => num !== sourceMatchId);
    }
  }
  assert.equal(expectedNumbers.length, 0);
});

LoserTeamSourceInfo.run();
